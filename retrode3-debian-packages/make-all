#!/bin/bash
# make all packages for Retrode3
#
# if we rebuild the binaries (option -b),
# this requires a Retrode3 connected and running RNDIS
# also needs to have gcc / g++ installed (apt-get install g++) there

function check {
	if ssh root@192.168.0.202 'ls -ld / /etc /etc/sudoers*' | fgrep letux
	then
		echo "!!! $0 FAIL $1 !!!"
		exit 1
	fi
}

set -e

BUILD_PACKAGES=true
BUILD_TOOL=false
INSTALL_PACKAGES=true

check 1

while [ "$1" ]
do
	case "$1" in
		-b ) BUILD_TOOL=true;;
		-p ) BUILD_PACKAGES=false;;
		-i ) INSTALL_PACKAGES=false;;
		-* ) echo unknown option "$1"; exit 1;;
		* ) break;
	esac
	shift
done

check 2

if $BUILD_TOOL
then
	echo build retrode tool and package
	export DEPLOY=false DEVICE=otg	# do not auto-install by .qcodeproj	# DEPLOY will damage the permissions of / or /etc/sudoers.d
	DEV=root@192.168.0.202	# for ssh and rsync
	CARTREADER=/Volumes/Retrode3/Retrode3-Software/Cart_Reader
	BINDIR=/usr/local/bin/
	ROOTDIR=/usr/local/games/retrode/

	cat <<'END' | con $DEVICE
[ "$(which g++)" ] && echo g++ available || apt-get -y --force-yes install g++
END

check 3

	echo remote build retrode-tool

	(
		cd retrode-tools
		mkdir -p ./$BINDIR/ ./$ROOTDIR/
		( cd $CARTREADER && make clean all remote )
		echo fetch retrode binary
		cp $CARTREADER/retrode ./$BINDIR/retrode
		cp -R $CARTREADER/../sd/* ./$ROOTDIR
	)

check 4

	echo remote build ucon64
	(
		cd retrode-tools
		SRCDIR=/usr/local/src/ucon64
		rsync -rltDvzh "./ucon64-2.2.2-src/" "$DEV:$SRCDIR"
		cat <<END | con $DEVICE
cd
cd $SRCDIR/src
./configure --disable-parallel
make
./install.sh
END
		echo fetch ucon binary
		scp $DEV:$BINDIR/ucon64 ./$BINDIR/ucon64
	)
fi

check 5

echo "Check retrode-web-control"
for i in retrode-web-control/var/www/html/*.php;
do
	php -l $i || exit 1
done

check 6

if $BUILD_PACKAGES
then

echo "Build retrode3.deb (and subpackages)"
RECURSIVE=true ./retrode3.qcodeproj	# could make others recursively but then we have no clear list
fi

check 7

if $INSTALL_PACKAGES
then

PACKAGES+=" retrode-hidd"
PACKAGES+=" retrode-controller-gadget"
PACKAGES+=" retrode-smb"
PACKAGES+=" retrode-tools"
PACKAGES+=" retrode-udev-rules"
PACKAGES+=" retrode-web-control"
PACKAGES+=" ucon64"
PACKAGES+=" retrode3"

echo installing Debian Packages: $PACKAGES

check 8

./dl-deb -o $PACKAGES

check 9

fi

open http://192.168.0.202
