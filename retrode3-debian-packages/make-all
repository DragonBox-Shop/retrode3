#!/bin/bash
# make all packages for Retrode3
#
# if we rebuild the binaries (option -b),
# this requires a Retrode3 connected and running RNDIS
# also needs to have gcc / g++ installed (apt-get install g++) there

DEV=root@192.168.0.202	# for ssh and rsync

function check {
	if ssh $DEV 'ls -ld / /etc /etc/sudoers*' | fgrep letux
	then
		echo "!!! $0 FAIL $1 !!!"
		exit 1
	fi
}

set -e

BUILD_PACKAGES=true
BUILD_TOOL=false
INSTALL_PACKAGES=true

check 1

while [ "$1" ]
do
	case "$1" in
		-b ) BUILD_TOOL=true;;
		-p ) BUILD_PACKAGES=false; INSTALL_PACKAGES=false;;
		-i ) INSTALL_PACKAGES=false;;
		-* ) echo unknown option "$1"; exit 1;;
		* ) break;
	esac
	shift
done

check 2

if $BUILD_TOOL
then
	echo build retrode tools and packages
	export DEPLOY=false # do not auto-install by .qcodeproj	# DEPLOY will damage the permissions of / or /etc/sudoers.d
	CARTREADER=$(cd ../Cart_Reader; pwd)
	BINDIR=/usr/local/bin/
	ROOTDIR=/usr/local/games/retrode/

check 3

	echo remote build oscr command line tool

	(
		cd retrode-tools
		mkdir -p ./$BINDIR/ ./$ROOTDIR/ ./$BINDIR/../include ./$BINDIR/../lib ./$BINDIR/../man/man1 ./$BINDIR/../man/man3
		( cd $CARTREADER && make clean all remote )	# makes local version with HOSTCC to find bugs early and then remote
		echo fetch oscr binary
		cp $CARTREADER/oscr ./$BINDIR/oscr
		cp $CARTREADER/oscr.groff ./$BINDIR/../man/man1/oscr.groff	# man page
		cp $CARTREADER/retrode-lib.h ./$BINDIR/../include/retrode-lib.h
		cp $CARTREADER/retrode-lib.o ./$BINDIR/../lib/retrode-lib.o
		cp $CARTREADER/retrode-lib.groff ./$BINDIR/../man/man3/retrode-lib.groff	# man page
		cp -R $CARTREADER/../sd/* ./$ROOTDIR
	)

check 4

	echo remote build ucon64
	(
		cd retrode-tools
		SRCDIR=/usr/local/src/ucon64
		rsync -rltDvzh "./ucon64-2.2.2-src/" "$DEV:$SRCDIR"
		cat <<END | ssh $DEV
cd
cd $SRCDIR/src
./configure --disable-parallel
make
./install.sh
END
		echo fetch ucon binary
		scp $DEV:$BINDIR/ucon64 ./$BINDIR/ucon64
	)
fi

check 5

echo "Check retrode-web-control"
for i in retrode-web-control/var/www/html/*.php;
do
	php -l $i || exit 1
done

check 6

echo "Prepare zipped groff man pages"
find . -name '*.groff' | while read MANFILE
do
	DIR=$(dirname "$MANFILE")/../
	BASE=$(basename "$MANFILE" .groff)
	SECTION=$(fgrep '.TH man ' <"$MANFILE" | cut -d ' ' -f 3)
	[ "$SECTION" ] && mkdir -p $DIR/../man/man$SECTION && gzip <$MANFILE >$DIR/../man/man$SECTION/$BASE.$SECTION.gz
done

check 7

if $BUILD_PACKAGES
then

echo "Build retrode3.deb (and subpackages)"
RECURSIVE=true ./retrode3.qcodeproj	# could make others recursively but then we have no clear list
fi

check 8

if $INSTALL_PACKAGES
then

PACKAGES+=" retrode-hidd"
PACKAGES+=" retrode-controller-gadget"
PACKAGES+=" retrode-storage-gadget"
PACKAGES+=" retrode-smb"
PACKAGES+=" retrode-udev-rules"
PACKAGES+=" retrode-web-control"
PACKAGES+=" oscr"
PACKAGES+=" ucon64"
PACKAGES+=" retrode-tools"
PACKAGES+=" retrode3"

echo installing Debian Packages: $PACKAGES

check 9

./dl-deb -o $PACKAGES

check 10

open http://192.168.0.202

fi
