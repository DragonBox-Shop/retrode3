#!/bin/bash -p
# retrode-admin cmd - system admin tasks

# Fehlerbehandlung nach PHP verschieben?
# zu einem daemon machen den das PHP per REST-API triggern/steuern kann?
# dann blockieren längere Aktivitäten das PHP nicht

# sollte als sudo ausgeführt werden

set -e

case "$1" in
	poweroff )
		shift
		poweroff && echo Will power off now... || echo failed.
		;;
	apt-get-upgrade )
		if [ "$(date "+%Y")" -ge 2025 ]
		then
			yes | apt-get update && yes | apt-get upgrade &&
				echo System updated. Now rebooting... &&
				reboot || echo failed.
		else
			echo "Refusing to update OS with bad system time."
			exit 1
		fi
		;;
	creation-date )
		date -r /makesd.info '+%Y-%m-%d %H:%M:%S'
		;;
	last-os-update )
		FILE=/var/lib/apt/lists/download.goldelico.com_letux-debian-rootfs_debian_dists_jessie_main_binary-mipsel_Packages
		if [ -r /var/log/apt/history.log ]
		then
			awk '/Commandline:/,/End-Date: /{if(/End-Date: /)print $2, $3}' /var/log/apt/history.log | tail -1
		elif [ -r $FILE ]
		then
			date -r $FILE '+%Y-%m-%d %H:%M:%S'
		else	# fall back to creation date
			date -r /makesd.info '+%Y-%m-%d %H:%M:%S'
		fi
		;;
	update-game-database )
		if [ "$(date "+%Y")" -ge 2025 ]
		then
			wget -qO /tmp/cart_reader.zip https://codeload.github.com/sanni/cartreader/zip/refs/heads/master &&
				unzip -q /tmp/cart_reader.zip 'cartreader-master/sd/*' -d /tmp/$$ &&
				mv -f /tmp/$$/cartreader-master/sd/* /usr/local/games/oscr &&
				echo Cart database updated. || echo Update failed.
		else
			echo "Refusing to update database with bad system time."
			exit 1
		fi
		;;
	restart-ntpd )
		service ntp stop
		ntpd -gq
		service ntp start
		;;
	* )
		echo unknown command "$1"
		echo "  poweroff, apt-get-upgrade, creation-date, last-os-update, update-game-database, restart-ntpd"
		exit 1
		;;
esac
